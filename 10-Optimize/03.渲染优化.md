# JavaScript 基础

浏览器在加载并解析完成头部资源才会真正开始渲染页面；

- 阻塞 HTML 页面解析 Block Parsing：
  - `script`标签加载 js 会阻塞页面解析
  - HTML 页面会被继续下载
  - 阻塞点后面的标签不会被解析
  - `img`、`link`等不会发送请求获取外部资源
- 阻塞 HTML 页面渲染 Block Rendering：
  - `link`、`style`标签加载 css 不会阻塞页面解析，但是会阻塞页面渲染
  - HTML 页面会被继续下载
  - 阻塞点后面的标签会继续被解析
  - `img`、`link`等会继续发送请求获取外部资源
  - 不会合成 Rnedering Tree，不会触发页面渲染，也不会执行 JavaScript 代码

## 网页加载和渲染流程

理解页面的加载和渲染流程是优化页面渲染的必要知识，浏览器的核心分为两部分，渲染引擎和 JavaScript 引擎，两个引擎交替渲染，页面的加载渲染流程大致为以下步骤：

### 页面加载流程

### 页面渲染流程

1. 浏览器一边下载 HTML 网页，一边解析，构建 DOM Tree
2. 浏览器以内置默认样式构建 CSSDOM Tree， CSSDOM Tree 主要由以下几部分构成：
   1. 浏览器根据内置样式
   2. inline style 和 internal style
   3. external style
3. 使用 DOM Tree 和 CSSDOM Tree 构建 Render Tree，然后渲染页面
4. 解析过程中发现`script`标签
5. 暂停解析，网页渲染的控制权转交给 JavaScript 引擎
6. 如果 script 标签引用了外部脚本，就下载该脚本，否则就直接执行
7. 执行完毕，控制权交还渲染引擎，恢复往下解析 HTML 网页

// TODO ##避免浏览器样式闪烁
FOUC(Flash Of Unstyled Content)浏览器样式闪烁，在页面加载渲染完成后又加载新的的样式，导致页面重新渲染。
为了避免这种情况要将 external style 放到`head`标签中进行加载，在页面渲染之前构建相对完整的 CSSDOM Tree。

[Modernizr](https://modernizr.com/)会在将`html`标签中的 class`no-js`替换为`js`，我们可以利用这个类在页面加载完成之前做一些处理，例如将`body`隐藏，在页面加载完成之后再显示。

```html
<style>
  .no-js body {
    display: none !important;
  }
</style>
```

这种方案会使白屏时间增长，
// TODO
更好的解决方案

浏览器运行 JavaScript 有两大特性

1. 载入后马上执行；
2. 执行时会阻塞后续内容，包括页面渲染和其它资源的下载；

#### defer 属性

```HTML
 <script src="1.js" defer></script>
```

defer 属性是让浏览器在 DOM 加载完成后再执行脚本；defer 属性对内置脚本和动态生成的脚本不起作用；
IE6 开始支持，IE 专属属性

1. 浏览器开始解析 HTML 网页
2. 解析过程中，发现带有 defer 属性的 script 标签
3. 浏览器继续往下解析 HTML 网页，同时并行下载 script 标签中的外部脚本
4. 浏览器完成解析 HTML 网页，此时再执行下载的脚本

#### async 属性

```HTML
 <script src="1.js" async></script>
```

async 属性可以保证脚本下载时不阻塞浏览器渲染；但是该属性无法保证脚本的正确执行属性，下载完成后直接执行；
async 和 defer 属性同时使用的情况下 defer 不起作用；

1. 浏览器开始解析 HTML 网页
2. 解析过程中，发现带有 async 属性的 script 标签
3. 浏览器继续往下解析 HTML 网页，同时并行下载 script 标签中的外部脚本
4. 脚本下载完成，浏览器暂停解析 HTML 网页，开始执行下载的脚本
5. 脚本执行完毕，浏览器恢复解析 HTML 网页

##### [脚本动态加载](http://javascript.ruanyifeng.com/bom/engine.html#toc8)

##### 页面的重绘(repaint)和重流(reflow)

- 重绘：修改页面颜色等会导致页面重绘
- 重流：改变元素布局会导致页面 reflow 和 repaint

重绘和重流会消耗很多时间和资源，应该尽量减少重绘和重流

- 读取 DOM 或者写入 DOM，尽量写在一起，不要混杂
- 缓存 DOM 信息
- 不要一项一项地改变样式，而是使用 CSS class 一次性改变样式
- 使用 document fragment 操作 DOM
- 动画时使用 absolute 定位或 fixed 定位，这样可以减少对其他元素的影响
- 只在必要时才显示元素
- 使用 window.requestAnimationFrame()，因为它可以把代码推迟到下一次重流时执行，而不是立即要求页面重流
- 使用虚拟 DOM（virtual DOM）库

## 参考

[Javascript 装载和执行](http://coolshell.cn/articles/9749.html)
