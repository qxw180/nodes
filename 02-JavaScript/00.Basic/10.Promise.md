# Promise

Promise(承诺)是一个对象，Promise 构造函数接收`(resolve, reject) => void`函数对象。在实例化后会执行该函数函数，并且**保证异步的返回函数的执行结果**。

Promise 的`then`方法相对于`callback`可以实现更加优异的异步操作状态管理，避免代码陷入回调地狱。

## 基本用法

Promise 对象是一个构造函数，用来生成 Promise 实例，参数是`(resolve, reject) => void`形式的函数，以下统称为*实例方法*。`resolve`和`reject`这两个参数也是函数。

Promise 实例有三种状态，`resolve`和`reject`函数可以改变实例的状态，实例的**状态转换是不可逆的**：

- 进行中(Pending)：实例初始状态，新建之后**立即开始执行**实例方法，实例初始状态为`Pending`。
- 已完成(Resolved)：在实例方法内调用`resolve`方法后，实例状态转换为`Resolved`
- 已失败(Rejected)：在实例方法内调用`reject`方法或者在有异常抛出后，实例状态转换为`Rejected`

每一个 Promise 实例都有`then`方法用来指定 Resolved 和 Rejected 的回调函数。

注意：**实例方法内调用 resolve 或者 reject 函数更新实例状态后，并不会终止实例函数内部剩余代码执行**

```JavaScript
var promise = new Promise(function(resolve,reject){
  if(/*操作成功*/){
    resolve(value);
  }else{
    reject(err);
  }
});

promise.then(
  (value) => {
    // success
  },(err) => {
    // fail
  }
);
```

## 实例方法

- `Promise.prototype.then(callBackResolve, callBackReject)`：Promise 实例状态改变后的回调函数
  - 参数：
    - `callBackResolve`：Resolved 状态回调函数
    - `callBackReject`：Rejected 状态回调函数
  - 返回值：
    - 一个新的 Promise 实例，then 方法后面可以在调用另一个 then 方法。
- `Promise.prototype.catch(callBackReject)`：相当于`.then(null,reject)`，用于指定错误时的回调函数
  - 参数
    - `callBackReject`：Rejected 状态回调函数
  - 返回值：
    - 一个新的 Promise 实例
- `Promise.prototype.finally(onFinally)`：在 promise 结束时，无论结果是 `resolved` 或者是 `rejected`，都会执行指定的回调函数
  - 参数
    - `onFinally`：回调函数

```JavaScript
getJSON("/post/1.json")
  .then(function(post) {
    return getJSON(post.commentURL);
  }).then((comments) => {
    console.log("Resolved: ", comments);
  }).catch((err) =>{
    console.log("rejected: ", err);
}));
```

## 静态方法

- `Promise.resolve(value)`：返回一个状态为 `resolved` 的 Promise 实例
- `Promise.reject(reason)`：返回一个状态为 `rejected` 的 Promise 实例
- `Promise.all(promiseInstanceArray)`：将多个 Promise 实例包装成一个 Promise 实例
  - 参数：
    - `promiseInstanceArray`：Promise 对象实例数组
  - 返回值：
    - 一个新的 Promise 实例
      - 只有参数中所有的实例都为 `resolved`，返回实例的状态才为 `resolved`，返回值为所以实例返回值的数组
      - 只要参数中有一个实例的状态为 `rejected`，返回实例的状态即为 `rejected`，返回值为第一个 `rejected` 实例的值
- `Promise.race(promiseInstanceArray)`：将多个 Promise 实例包装成一个 Promise 实例
  - 参数：
    - `promiseInstanceArray`：Promise 对象实例数组
  - 返回值：
    - 一个新的 Promise 实例，只要实例数组中有一个实例的状态改变，返回实例的状态就改变，值为第一个改变实例的值

## [异常处理](../02.Core/04-异常处理.md)

promise 实例内函数抛出的异常不能被`try catch`语句捕获，只能在实例回调函数`then`或`catch`内处理

`catch`和`then`的第二个参数是一样的，区别是`catch`还可以捕获`then`方法内抛出的异常。
