# Nginx作为代理服务使用

## 反向代理和反向代理

正向代理：用于配置代理服务器，所有请求通过代理服务器发出，翻墙VPN；
反向代理：服务的端由一台代理服务器进行请求的转发，无需用户配置，用户无感知，负载均衡；

## 反向代理配置

``` nginx
http {
    server {
        location / {
            root http://localhost:8080;
        }
        location ~ \.(gif|jpg|png)${
            root /data/assets;
        }
    }
    server {
        listen 8080;
        root /data/www;
        location / {
        }
    }
}


server {
    listen 90;
    server_name www.example.com;
    root /var/www;
    location /o2blog_wx/ {
        # 反向代理我们通过proxy_pass字段来设置
        # 也就是当访问http://aotu.jd.com/o2blog_wx的时候经过Nginx反向代理到服务器上的http://127.0.0.1:3000
        # 同时由于解析到服务器上的时候o2blog_wx这个字段都要处理
        # 所以通过rewrite字段来进行正则匹配替换
        # 也就是http://aotu.jd.com/o2blog_wx/hello经过Nginx解析到服务器变成http://127.0.0.1:3000/hello
        proxy_pass http://127.0.0.1:3000;
        rewrite ^/o2blog_wx/(.*) /$1 break;
    }
}
```

## 反向代理获取用户真是IP和cookie

``` nginx
server {
    ...
    location / {
        ...
        proxy_set_header    Host $host;
        proxy_set_header    X-real-ip $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

然后web服务端就可以可以通过`request.getHeader("X-Forwarded-For");`来获得真实的用户ip
