# 浏览器架构

浏览器是**多进程架构**（注意是进程，不要和 JS 单线程混淆），浏览器的主进程负责进程直接的协调，浏览器通常会为每个页面分配一个单独的**渲染进程**

![Browser Process](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71df0dedf3484d99ba6de74403383e2f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- 主进程（浏览器进程）
  - 负责浏览器面显示与用户交互(前进、后退等)
  - 控制页面创建、销毁等，为每个标签页创建一个渲染进程
  - 处理网络请求
  - 处理文件访问
- 渲染进程：每个标签一个，各进程互不影响，主要负责页面渲染、脚本执行和事件处理等
- 第三方进程：插件进程，每个插件一个
- GPU 进程：处理独立于其它进程的 GPU 任务

![Browser Process Demo](../../assets/images/browser/browser-process.png)

## 渲染进程

渲染进程即渲染引擎(即我们常说的浏览器内核)工作进程，浏览器的渲染进程是**多线程的**，主要负责页面渲染、脚步执行和事件处理等

- GUI 渲染线程：负责页面渲染，DOMTree、CSSOM Tree、Render Tree 构建，Layout 和 Render
  - 重绘和重流触发触发该线程
  - GUI 线程和 JS 引擎线程是互斥的，详见[关键渲染路径&渲染优化-页面阻塞](./2.关键渲染路径&渲染优化.md)
- JS 引擎线程：也称 JS 内核(例 V8)，负责解析和执行 JS 脚本
  - 一个页面只有一个 JS 线程
  - 因为与 GUI 渲染线程互斥，所以 JS 运行时间过长会导致页面掉帧
  - JS 引擎一直在等待任务队列中的任务然后执行，详见[JS 运行机制](../../02-JavaScript/02.Core/05-运行机制%20Event%20Loop.md)
- 事件触发线程：由浏览器控制，负责控制 Event Loop
  - JS 引擎调执行`setTimeout`、异步请求或事件监听等代码块时会将代码会添加到事件线程
  - 当事件触发后事件触发线程会将对于的代码块和触发数据一起添加到任务队列
- 定时器触发线程：`setInterval`与`setTimeout`所在线程
- 异步 HTTP 请求线程：`XMLHttpRequest`连接后通过浏览器开启的请求线程

## TODO:页面加载流程

在浏览器输入一个 URL 到页面加载完成大概分为以下几大步骤：

![Page Render Flow](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b25113fced254aeea1a77fca56919162~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

1. 浏览器输入 url，浏览器主进程接管，开一个下载线程
   1. DNS 寻址及 IP 解析
   2. TCP 链接
   3. 请求、响应、文档下载
2. 将下载内容通过`RendererHost`接口转交给渲染进程
   1. 建立 DOMTree、CSSOMTree 和 RenderTree 并渲染页面

## 参考资料

[浏览器简史及其核心原理详解：47 张图带你走进浏览器的世界](https://juejin.cn/post/6983896089703235592)
