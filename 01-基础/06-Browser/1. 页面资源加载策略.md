# HTML 页面中的资源加载策略

## TODO:资源加载策略

- 并发数

## script 脚本 defer async

HTML 页面通过`script`标签可以加载外部 JS 脚本，总共有三种方式：

1. 普通模式：`<script src="path.js" />`
2. Defer 模式：`<script src="path.js" defer />`
3. Async 方式：`<script src="path.js" async />`

如果在`script`标签上同时设置`async`和`defer`属性，**`async`属性拥有更高的优先级**

![JS脚本加载时间轴](../assets/images/script-defer-async.jpeg)

如上图不同的模式会对页面的解析和渲染产生不同的影响。

- 普通模式：在 DOM 解析过程中遇到`script`标签会停止解析，等待脚本加载运行完成后再继续进行解析。
- Defer 模式：不会中断 DOM 解析，会在后台进行脚本下载，在 DOM 解析完成后(DOMContentLoaded 之前)执行。
- Async 模式：和 Defer 模式相同的是也会在后台进行进行脚本下载，不同的是在脚本加载完成后会中断 DOM 解析立即执行脚本。

另外如果存在多个非普通模式脚本，Defer 模式会按照声明顺序依次执行，而 Async 则会根据加载完成顺序执行，即先加载完成的先执行。

## TODO: Prefetching&Preloading

## TODO: window.onload & DOMContentLoaded

Defer Script 执行完成

- `domLoading`：浏览器开始解析 dom 树的时间点
- `domInteractive`：浏览器已经完成 dom 树解析
- `domContentLoadedEventStart`：开始执行同步 JS，`domContentLoadedEventEnd`：同步 js 执行完毕
  - 由于同步 JS 会阻塞 Dom 的解析，因此在有同步 JS 的情况下，domInteractive 和 domContentLoaded 的区别不大。
  - 如果 JS 添加了`defer`属性，那么`domInteractive`和`domContentLoaded`的时间差取决于 JS 的下载和执行时间。defer JS 表示告诉浏览器，这段 JS 在`domInteractive`后执行。一旦执行完 defer JS，就会触发`domContentLoaded`.
  - 如果 JS 属性为`async`，那么`domContentLoaded`和`domInteractive`又几乎没什么区别了，因为 js 的解析不会阻塞 dom，也不阻塞`domContentLoad`事件。

## DOMContentLoaded 和 load

DOMContentLoaded 即 DOM 加载完成，jQuery 中`$(document).ready(function()`监听的是 DOMContentLoaded

页面内的其它资源如图片、音频、视频等加载完成之后才会触发 load，jQuery 中`$(document).load(function()`监听的是 load。`window.onload = function(){}`onload 事件所有浏览器都支持，不需要考虑浏览器兼容性
