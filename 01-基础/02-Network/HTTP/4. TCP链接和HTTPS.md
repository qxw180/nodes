# TCP 协议

TCP 协议是一个**端到端的连接协议**。拿到域名对应的 IP 地址之后，浏览器会以一个随机端口(1024 < 端口 < 65535)向服务器的 WEB 程序(httpd,nginx 等)80 端口发起 TCP 的连接请求。这个连接的建立过程分三步，俗称 3 次握手；

1. 浏览器首先向服务器发送一个带`SYN`标志的数据包，并进入 SYN_SEND 状态，等待服务器确认；
2. 服务器接收到数据包后返回一个带有`SYN/ACK`的数据包，此时服务器进入 SYN_RECV 状态；
3. 最后浏览器在发送一个带有`ACK`的数据包给服务器，客户端和服务器进入 ESTABLISHED 状态，代表握手结束，连接成功；

三次握手的意义在于验证发送端和接收端是都准守`TCP/IP`协议

## TCP 连接断开

在请求和响应结束后，需要断开 TCP 连接，因为连接是双向的，所以浏览器和客户端需要分别断开，

1. 客户端发送一个 FIN，用来关闭客户 A 到服务器 B 的数据传送
2. 服务器收到这个 FIN，它发回一个 ACK，确认序号为收到的序号加 1。和 SYN 一样，一个 FIN 将占用一个序号。
3. 服务器 B 关闭与客户端 A 的连接，发送一个 FIN 给客户端 A。
4. 客户端 A 发回 ACK 报文确认，并将确认序号设置为收到序号加 1。

## HTTPS

HTTPS 就是安全版的 HTTP，可以有效的防止运营商劫持。默认 HTTP 的端口号为 80，HTTPS 的端口号为 443。
HTTP 协议通常承载于 TCP 协议之上，HTTPS 运行在 SSL/TLS 上，SSL/TLS 运行在 TCP 协议上，对传输的内容进行加密；

## 信息安全

保证信息安全需要做到以下三点：

1. 信息的保密性：参考[加密&SSH](../../../01-常用/加密&SSH.md) 对称加密+非对称加密保证
2. 信息的完整性
3. 身份识别

### 信息完整性

信息在传输的过程中很容易被劫持串改，保证信息完整性通常采用的方案是：

- step1: 使用散列算法对传输的数据进行一次 hash，获取 hash 值，即摘要
- step2：使用服务端的公钥对内容和摘要进行加密，然后一起发送给服务端
- step3：服务端使用私钥对内容和摘进行解密，将解密的内容进行一次 hash 和解密的摘要进行对比，如果一致则证明数据是完整的

### 身份识别

信息接收方需要信息发送方的身份，通常采用的策略是：

- step1：信息发生方将自己的公钥发生给接收方
- step2：信息发送方使用私钥加密信息并发送给接收方
- step3：信息接收方收到信息，使用之前得到的公钥进行解密，这就确保了接收的信息来自可靠的发送方

## 数字证书

加密通信的过程，客户端首先需要获取服务的公钥，在获取公钥的过程中存储中间人攻击的风险，为了防止这种情况的出现，数字证书就出现了。
数字证书是由权威的 CA（Certificate Authority）机构给服务端进行颁发，任何人/组织都可以扮演 CA 的角色，但是很难被浏览器信任。

数字证书由：证书内容、散列算法和加密密文三部分组成。

证书内容主要包括持有人相关信息、服务器的公钥和数字签名：

- 服务器公钥：客户端和服务端通信过程中进行加密和解密，保证信息保密性
- 数字签名：数字签名可以保证公钥和正式信息的完整性
- 证书持有人信息：通过验证持有人信息，可以确保证书来自请求的服务器

客户端在和覆盖度通信之前首先需要获取服务端的数字证书，那么如何保证数字证书的获取过程中不会被劫持伪造呢？

上面说道证书包含证书内容、散列算法和加密密文三部分，CA 机构在生成证书的过程中会将证书内容会通过散列算法计算出一个 hash，然后使用 CA 机构提供的私钥对 hash 进行加密生成加密密文，将这个三部分信息打包生成一个数组证书。
客户端在获取服务端证书之后，客户端会通过 CA 的公钥对证书的密文进行解密获取到 hash，然后使用证书的 hash 算法再次正式内容进行计算，对比两个 hash 值一致就可以确认证书的可靠性。

所以说 HTTPS 的可靠性是建立在 CA 机构的可靠程度上

## TODO

1. 证书申请及部署
2. HTTPS 链接创建过程
