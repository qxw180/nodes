# 页面加载渲染流程

在浏览器输入一个URL到页面加载完成大概分为以下几大步骤：

1. 页面加载
2. 页面解析及渲染

## 页面加载

+ Step1、DNS寻址及IP解析
+ Step2、TCP链接
+ Step3、请求、响应、文档下载

## 页面解析及渲染

页面加载完成后浏览器会从上到下解析文档生成DOM，在解析的过程中会将页面中的CSS内容生成CSSOM，最后使用DOM和CSSOM生成渲染树将其绘制在浏览器上。HTML的解析过程是可以被中断的，即**页面阻塞**。
**JS阻塞**：当解析的过程中遇到`<script>`标签便会停止解析去处理脚本，即解析阻塞，如果是内联脚本则会在脚本运行结束之后继续进行解析，如果是外联脚本则会下载脚本运行之后继续继续解析。
**CSS阻塞**：CSS不会阻塞DOM树解析,CSS会阻塞渲染树的解析，并且会**阻塞后面JS语句**的执行。

`<script>`标签使用`defer`和`async`属性可以缓解JS阻塞问题，但是这两个标签对inline-script是无效的。

### defer

``` HTML
<script src="app1.js" defer></script>
<script src="app2.js" defer></script>
<script src="app3.js" defer></script>
```

`defer`属性表示延迟执行引入的 JavaScript，整个 document 解析完毕且 defer-script 也加载完成之后，会执行所有由 defer-script 加载的 JavaScript 代码，然后触发 `DOMContentLoaded` 事件。
defer 不会改变 script 中代码的执行顺序，示例代码会按照 1、2、3 的顺序执行。defer-script载入时不阻塞 HTML 的解析，执行阶段被放到 HTML 标签解析完成之后。

### async

`async`属性表示异步执行引入的 JavaScript，与 `defer` 的区别在于，如果已经加载好，就会开始执行。多个 async-script 的执行顺序是不确定的。

``` html
<script src="app.js" async></script>
<script src="ad.js" async></script>
<script src="statistics.js" async></script>
```

+ `domLoading`：浏览器开始解析dom树的时间点
+ `domInteractive`：浏览器已经完成dom树解析
+ `domContentLoadedEventStart`：开始执行同步JS，`domContentLoadedEventEnd`：同步js执行完毕
  + 由于同步JS会阻塞Dom的解析，因此在有同步JS的情况下，domInteractive和domContentLoaded的区别不大。
  + 如果JS添加了`defer`属性，那么`domInteractive`和`domContentLoaded`的时间差取决于JS的下载和执行时间。defer JS表示告诉浏览器，这段JS在`domInteractive`后执行。一旦执行完defer JS，就会触发`domContentLoaded`.
  + 如果JS属性为`async`，那么`domContentLoaded`和`domInteractive`又几乎没什么区别了，因为js的解析不会阻塞dom，也不阻塞`domContentLoad`事件。

## DOMContentLoaded和load

DOMContentLoaded即DOM加载完成，jQuery中`$(document).ready(function()`监听的是DOMContentLoaded

页面内的其它资源如图片、音频、视频等加载完成之后才会触发load，jQuery中`$(document).load(function()`监听的是load。`window.onload = function(){}`onload事件所有浏览器都支持，不需要考虑浏览器兼容性
