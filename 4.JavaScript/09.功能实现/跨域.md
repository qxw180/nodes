#JavaScript跨域

##什么是跨域
> 一个网站的地址包括，协议名、子域名、主域名和端口号；
> 例：`https://www.github.com`，`https`是协议名，`www`是子域名，`github`是主域名，`80`是端口号；
> 两个网站的地址只要有协议名、子域名、主域名和端口号直接任意一个不相同就不是同域；

##为什么要跨域
> 因为浏览器的同源策略限制，当前域名的js只能读取同域下文档的属性；
> 在浏览器中，`<script>`、`<img>`、`<iframe>`、`<link>`等标签都可以加载跨域资源；
> 但是浏览器限制了JavaScript不能读、写加载的内容；
> 不能跨域进行ajax请求
> 不能夸iframe进行进行js交互

##跨域问题解决

####1.服务器转发
> 把任务扔给后台，在同域后台架设一个代理服务来转发请求；
> JavaScript复负责把请求发送到代理服务器
> 服务器负责请求并把结果返回

---
###2.JSONP
> 原理：利用了浏览器允许跨域加载资源，
> 首先在文档中动态引入一个js文件；
> 这个js文件加载后会执行我们在`url`参数中指定的`callback`函数，并把请求的数据作为参数传入；
	
	function coGet(){
		var tag = document.createElement('script');
		tag.type = "text/javascript";
		tag.src = "http://www.test.com?callback=callBack"
		document.getElementsByTagName('head')[0].appendChild(tag);
	}

	function callBack(msg){
		console.log(msg);
	}

	coGet();

	// 加载的js文件内容为；
	callBack("HELLO JSONP");

> 优点：兼容性好，简单易用
> 缺点：只支持get请求

###3.CORS 
> Cross-Origin Resource Sharing H5规范定义的跨域资源访问
> 原理是，当发生跨域资源访问的时候，`response`会有一个`Access-Control-Allow-Origin`属性
> 浏览器会检测属性值中是否包含本域
> 如果包含则请求成功，如果失败将无法获取任何数据
> 优点：简单方便
> 缺点：兼容性问题

###4.document.domain
> 不同的iframe直接不能进行js交互，但是可以获取彼此的`window`对象，
> 但是仍然不能获取`window`的属性和方法，除非`document.domain`属性一致
> `document.domain`属性的设置是有限制的，只能设置为自身域名或者更高一级的域名
> 也就是说如果主域名不一致那么这种方法无效

###5.window.name
> `window`对象都有一个`.name`属性，每个页面都对该属性有读写的权限
> 该属性是一个持久属性，不会因为页面的重新载入而刷新

	// a.html
	<script>
		window.name = "Test Window Name";
		setTimeout(function(){
			window.location = 'b.html';
		},3000);
	</script>

	// 3秒之后跳转到 b.html
	<script>
		console.log(window.name); // Test Window Name
	</script>
	// 在b.html中仍然能够获得a.html中设置的内容

> 利用这个原理我们可以设置一个充当中介的iframe来获取数据并写入`window.name`属性中
> 然后把这个iframe的地址设置为同源的就可以获取iframe中的数据；


###6.window.postMessage
> `window.postMessage(message,targetOrigin)`方法是html5新引进的特性，IE8+都支持
> 可以用来想其它`window`对象（iframe的window）发送信息，无论是否同源
> `message`参数为发送的信息，只能为字符串
> `targetOrigin`限定用来接收信息的`window`对象所在的域，如果不限定可以使用通配符`*`

	<script>
		var iframe = document.getElementById('frame1');
		var win = iframe.contentWindow;
		win.postMessage("Hello Post Message");
	</script>
	<iframe id="frame1" src="b.html">
	
	// b.html
	<script>
		window.onmessage = function(e){
			console.log(e.data);
		}
	</script>


